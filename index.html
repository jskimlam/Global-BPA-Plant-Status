<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Global BPA Dashboard | Live Sync</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --primary: #1e3a8a; --accent: #3b82f6; --current: #1A1A1B; --future: #F59E0B; --bg: #F8FAFC; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        #layout { display: flex; height: 100vh; width: 100vw; position: relative; }
        #map { flex-grow: 1; height: 100%; background: #f1f5f9; z-index: 1; }
        #sidebar { position: absolute; left: 0; top: 0; width: 320px; height: 100%; background: white; z-index: 2000; transition: transform 0.5s ease; box-shadow: 5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #sidebar.hidden { transform: translateX(-100%); }
        #toggle-btn { position: absolute; right: -45px; top: 20px; width: 45px; height: 45px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 0 8px 8px 0; font-size: 18px; z-index: 2001; }
        .header { background: var(--primary); color: white; padding: 15px; cursor: pointer; }
        .global-cap { background: var(--accent); padding: 12px 15px; color: white; border-bottom: 2px solid rgba(0,0,0,0.1); cursor: pointer; }
        #list-container { flex-grow: 1; overflow-y: auto; background: var(--bg); }
        .group-header { padding: 10px 12px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.8rem; }
        .risk-header-current { background: var(--current); color: white; }
        .risk-header-future { background: var(--future); color: white; }
        .region-header { background: #cbdceb; color: var(--primary); }
        .country-header { background: #e2e8f0; color: #444; padding-left: 20px; font-size: 0.78rem; }
        .collapsible-content { display: none; }
        .open > .collapsible-content { display: block; }
        .plant-card { padding: 10px 12px 10px 30px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.72rem; background: white; position: relative; }
        .plant-card:hover { background: #f1f5f9; }
        .plant-card.current-risk { border-left: 5px solid var(--current); }
        .plant-card.future-risk { border-left: 5px solid var(--future); }
        .badge { font-size: 0.6rem; padding: 2px 4px; border-radius: 3px; color: white; background: var(--accent); float: right; margin-left: 5px; }
        .badge.black { background: var(--current); }
        .badge.yellow { background: var(--future); }
        .loss-badge { background: #ef4444; color: white; font-weight: bold; padding: 1px 5px; border-radius: 10px; font-size: 0.6rem; position: absolute; right: 10px; top: 8px; }
        .share-badge { background: #64748b; color: white; padding: 1px 4px; border-radius: 4px; font-size: 0.55rem; position: absolute; right: 10px; bottom: 8px; }
        .capa-info { color: #64748b; font-size: 0.62rem; margin-top: 2px; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; font-weight: bold; }
    </style>
</head>
<body>
<div id="loading-overlay">Íµ¨Í∏Ä ÏãúÌä∏ÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
<div id="layout">
    <div id="sidebar">
        <button id="toggle-btn" onclick="document.getElementById('sidebar').classList.toggle('hidden')">üìä</button>
        <div class="header" onclick="resetToGlobal()">
            <h1 style="margin:0; font-size:0.9rem;">Global BPA Status (Live)</h1>
            <p style="margin:3px 0 0 0; font-size:0.6rem; opacity:0.8;">Synced with Google Sheets</p>
        </div>
        <div class="global-cap" onclick="resetToGlobal()">
            <span style="font-size:0.62rem;">Global BPA Total Capacity</span><br>
            <strong id="global-val" style="font-size:1rem;">0</strong> <small>K MT/Y</small>
        </div>
        <div id="list-container">
            <div id="current-risk-group" class="open">
                <div class="group-header risk-header-current" onclick="this.parentElement.classList.toggle('open')"><span>‚ö†Ô∏è CURRENT RISK</span><span id="current-total-header"></span></div>
                <div class="collapsible-content" id="current-risk-list"></div>
            </div>
            <div id="future-risk-group" class="open">
                <div class="group-header risk-header-future" onclick="this.parentElement.classList.toggle('open')"><span>üìÖ FUTURE MAINT</span><span id="future-total-header"></span></div>
                <div class="collapsible-content" id="future-risk-list"></div>
            </div>
            <div style="background: var(--primary); color:white; padding:8px 12px; font-size:0.75rem; font-weight:bold;">üåê REGIONAL STATUS</div>
            <div id="region-list"></div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Íµ¨Í∏Ä ÏãúÌä∏ CSV Ï£ºÏÜå (ÏÇ¨Ïö©ÏûêÍ∞Ä Ï£ºÏã† HTML Ï£ºÏÜåÎ•º CSVÏö©ÏúºÎ°ú Î≥ÄÌôòÌï®)
    const CSV_FILE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRJ659lNQ3RNAjLbRviuRZ32mAXzzk2BBXA51LJ72s4gKaw_kOTLPhjjdTF_tYijv6qumvE7B9Gkyi/pub?output=csv';

    const regionFlyTo = { "NEA": { c: [32, 122], z: 4 }, "SEA": { c: [5, 110], z: 5 }, "Western Europe": { c: [50, 10], z: 5 }, "Middle East": { c: [28, 50], z: 5 }, "North America": { c: [38, -95], z: 4 }, "South America": { c: [-25, -60], z: 4 }, "Central Europe": { c: [50, 18], z: 5 }, "CIS & Baltic": { c: [55, 50], z: 4 } };
    const regionColors = { "NEA": "#3b82f6", "SEA": "#10b981", "Western Europe": "#8b5cf6", "Middle East": "#f59e0b", "North America": "#f97316", "South America": "#64748b", "Central Europe": "#06b6d4", "CIS & Baltic": "#ec4899" };

    const map = L.map('map', {zoomControl: false}).setView([20, 10], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    // Íµ¨Í∏Ä ÏãúÌä∏ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    Papa.parse(CSV_FILE, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            initDashboard(results.data.filter(row => row.Company));
            document.getElementById('loading-overlay').style.display = 'none';
        },
        error: function(err) {
            document.getElementById('loading-overlay').innerText = "ÏóêÎü¨: Íµ¨Í∏Ä ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. ÏõπÏóê Í≤åÏãú ÏÑ§Ï†ïÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.";
        }
    });

    function initDashboard(data) {
        const globalTotalCapa = data.reduce((s, p) => s + (Number(p.Capacity) || 0), 0);
        document.getElementById('global-val').innerText = globalTotalCapa.toLocaleString();

        const calculateLoss = (p) => (!p.Days) ? 0 : ((p.Capacity / 365) * p.Days).toFixed(1);

        const currentRisks = data.filter(p => p.Status && p.Status.includes('Current'));
        const futureRisks = data.filter(p => p.Status && p.Status.includes('Future'));

        const curLossSum = currentRisks.reduce((s, p) => s + parseFloat(calculateLoss(p)), 0);
        const futLossSum = futureRisks.reduce((s, p) => s + parseFloat(calculateLoss(p)), 0);
        
        document.getElementById('current-total-header').innerText = `${curLossSum.toLocaleString()}K ‚ñº`;
        document.getElementById('future-total-header').innerText = `${futLossSum.toLocaleString()}K ‚ñº`;

        const nested = {};
        data.forEach(p => {
            if(!p.Lat || !p.Lng) return;
            const isCurrent = p.Status.includes('Current');
            const isFuture = p.Status.includes('Future');
            const m = L.circleMarker([p.Lat, p.Lng], { 
                radius: Math.sqrt(p.Capacity || 100) * 0.65, 
                fillColor: regionColors[p.Region] || '#333', 
                color: isCurrent ? '#000' : (isFuture ? '#F59E0B' : '#fff'), 
                weight: (isCurrent || isFuture) ? 4 : 1.5, 
                fillOpacity: 0.8 
            }).addTo(map);

            const lossVal = calculateLoss(p);
            let pop = `<b>${p.Company}</b><br>${p.Location}<br>Capa: ${p.Capacity}K<br>Status: <b>${p.Status}</b>`;
            if(p.Days) pop += `<br><span style="color:red; font-weight:bold;">Loss: ${lossVal}K MT</span><br><small>Period: ${p.Period}</small><br><small>Reason: ${p.Reason}</small>`;
            m.bindPopup(pop); p._m = m;

            if (!nested[p.Region]) nested[p.Region] = { capa: 0, countries: {} };
            if (!nested[p.Region].countries[p.Country]) nested[p.Region].countries[p.Country] = { capa: 0, plants: [] };
            nested[p.Region].capa += p.Capacity;
            nested[p.Region].countries[p.Country].capa += p.Capacity;
            nested[p.Region].countries[p.Country].plants.push(p);
        });

        const createCard = (p) => {
            const loss = calculateLoss(p);
            const card = document.createElement('div');
            const isRisk = p.Status && (p.Status.includes('Current') || p.Status.includes('Future'));
            card.className = `plant-card ${p.Status.includes('Current')?'current-risk':(p.Status.includes('Future')?'future-risk':'')}`;
            card.innerHTML = `${isRisk ? `<span class="loss-badge">${loss}K Loss</span>` : ''}<span class="badge ${p.Status.includes('Current')?'black':(p.Status.includes('Future')?'yellow':'')}">${p.Status.split('(')[0]}</span><b>${p.Company}</b><div class="capa-info">${p.Capacity}K MT | ${p.Days || 0} Days</div>`;
            card.onclick = (e) => { 
                const sidebar = document.getElementById('sidebar');
                const offset = sidebar.classList.contains('hidden') ? 0 : 320;
                const target = map.project([p.Lat, p.Lng], 9).subtract([offset / 2, 0]);
                map.flyTo(map.unproject(target, 9), 9, { duration: 2.0 });
                setTimeout(() => p._m.openPopup(), 1800); 
            };
            return card;
        };

        currentRisks.forEach(p => document.getElementById('current-risk-list').appendChild(createCard(p)));
        futureRisks.forEach(p => document.getElementById('future-risk-list').appendChild(createCard(p)));

        Object.entries(nested).sort((a,b)=>b[1].capa - a[1].capa).forEach(([rName, rData]) => {
            const rDiv = document.createElement('div');
            rDiv.innerHTML = `<div class="group-header region-header" onclick="this.parentElement.classList.toggle('open')"><span>${rName}</span><span>‚ñº</span></div><div class="collapsible-content"></div>`;
            const countryList = rDiv.querySelector('.collapsible-content');
            Object.entries(rData.countries).forEach(([cName, cData]) => {
                const cDiv = document.createElement('div');
                cDiv.innerHTML = `<div class="group-header country-header" onclick="this.parentElement.classList.toggle('open')"><span>${cName}</span><span>‚ñº</span></div><div class="collapsible-content"></div>`;
                const plantList = cDiv.querySelector('.collapsible-content');
                cData.plants.sort((a,b)=>b.Capacity - a.Capacity).forEach(p => plantList.appendChild(createCard(p)));
                countryList.appendChild(cDiv);
            });
            document.getElementById('region-list').appendChild(rDiv);
        });
    }

    function resetToGlobal() { map.flyTo([20, 10], 2, {duration: 2.0}); }
</script>
</body>
</html>
